# 🧭 Chrome 134 更新チェック（Stable＋コードサンプル付き）

- リリース日: 2025-03-04（Stable）
- 一次情報:
  - Release Notes: https://developer.chrome.com/release-notes/134?hl=ja
  - New in Chrome 134: https://developer.chrome.com/blog/new-in-chrome-134
  - New in DevTools 134: https://developer.chrome.com/blog/new-in-devtools-134
  - New in WebGPU 134: https://developer.chrome.com/blog/new-in-webgpu-134
  - ChromeStatus Roadmap: https://chromestatus.com/roadmap
  - MDN / Can I use: https://developer.mozilla.org/ja/docs/Web / https://caniuse.com/
  - Baseline: https://web.dev/baseline

---

## 🔹 全体サマリ
- HTML/UI: **`<dialog>` のライトディスミス（`closedby`）**、**カスタマイズ可能な `<select>`（`appearance: base-select`）**、**PWA Link Capture**
- CSS/UI: **`dynamic-range-limit`**（HDRの最大輝度制御）ほか
- Web API: **Shared Storage × Web Locks**（`withLock` / `batchUpdate()` / worklet で `navigator.locks.request`）、**Canvas Paint で `imageSmoothingQuality`**
- DevTools: **Privacy and security パネル**、**Calibrated CPU throttling**、**Forced reflow / Optimize DOM size インサイト**、**`console.timeStamp()` によるトレース拡張**
- WebGPU: **subgroups（SIMD レベル並列）** の一般提供、Dawn 更新 ほか

### 🚨 重要度の高いもの
- **`<dialog closedby>`** によるライトディスミス分岐（モーダル挙動の設計が素直に）
- **カスタム `<select>`**（`appearance: base-select` とパーサ緩和）でリッチな選択UI
- **Shared Storage に Web Locks**（整合性を保った原子的更新/重複集計の抑止）
- **DevTools の性能インサイト**（強制リフロー/DOMサイズ）でボトルネック特定を高速化
- **WebGPU subgroups** による ML/映像処理の高速化余地

---

## 🧩 HTML

### 1) `<dialog>` ライトディスミス（`closedby`）
```html
<dialog id="dlg" closedby="any">
  <form method="dialog">
    <p>設定を保存しますか？</p>
    <button value="cancel">キャンセル</button>
    <button value="ok">OK</button>
  </form>
</dialog>

<script>
  // closedby=none | closerequest | any
  // any: 外側クリック or ESC で閉じる（Popoverの light-dismiss 相当）
  dlg.showModal();
  dlg.addEventListener('close', () => {
    console.log('result:', dlg.returnValue);
  });
</script>
```

### 2) カスタマイズ可能な `<select>`（`appearance: base-select`）
```html
<label>アバターを選択
  <select id="avatar" class="base">
    <option value="cat"><img src="/img/cat.png" alt=""> ねこ</option>
    <option value="dog"><img src="/img/dog.png" alt=""> いぬ</option>
  </select>
</label>

<style>
  .base {
    appearance: base-select; /* ← 134 での新挙動に opt-in */
    inline-size: 18rem;
  }
  /* option 内の画像やレイアウトを自由に */
  option { display: grid; grid-template-columns: 1.5rem 1fr; gap: .5rem; align-items: center; }
  option > img { inline-size: 1.5rem; block-size: 1.5rem; }
</style>
```
> ※ 一時移行ポリシー `SelectParserRelaxationEnabled` により、`<select>` 内に追加タグを許容。将来 Chrome 141 で無効化予定。

---

## 🎨 CSS / UI

### `dynamic-range-limit`（HDR 最大輝度の上限）
```css
@media (dynamic-range: high) {
  video, canvas {
    dynamic-range-limit: 800nits; /* 端末のピーク輝度を抑えて白飛び回避 */
  }
}
```

---

## ⚙️ JavaScript / Web API

### 1) Shared Storage × Web Locks（原子的更新）
```js
// worklet 側（shared-storage-worklet.js）
// navigator.locks.request が利用可能になり、
// withLock オプションや batchUpdate() で整合性のある更新が可能。

registerProcessor('counter', class {
  async run() {
    await navigator.locks.request('reach-metrics', async () => {
      await sharedStorage.batchUpdate([
        ['add', 'impressions', 1],
        ['set', 'lastUpdate', Date.now()]
      ], { withLock: 'reach-metrics' });
    });
  }
});
```

### 2) Canvas Paint の `imageSmoothingQuality`
```js
const c = document.querySelector('canvas');
const ctx = c.getContext('2d', { alpha: false });
ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = 'high'; // 'low' | 'medium' | 'high'
ctx.drawImage(sourceImage, 0, 0, c.width, c.height);
```

### 3) PWA Link Capture（ブラウザ↔インストール済みWebアプリの移動を容易に）
```json
// web-app-manifest の例（抜粋）
{
  "capture_links": "new-client"
}
```

---

## 🧠 AI in Chrome
- （134時点）ブラウザ内のAI APIの新規メジャー追加は目立たず。
- 開発体験は DevTools 統合（下記）で強化。

---

## 🧰 DevTools
- **Privacy and security パネル**（旧 Security を刷新）
- **Calibrated CPU throttling**（端末ごとの実測ベースで低/中級機を近似）
- **Insights** に **Forced reflow / Optimize DOM size** を追加
- **`console.timeStamp()` 対応**で独自マーカーを軽量に記録

```js
// パフォーマンストレースに軽量マーカーを注入
console.timeStamp('app:boot');
// ... 初期化処理 ...
console.timeStamp('app:boot:done');
```

---

## 🌐 Web API（その他）

### `<select>` パーサ緩和（一時ポリシー）
- 追加タグ（画像など）を `<select>` 内で許容する移行措置。
- 管理ポリシー: `SelectParserRelaxationEnabled`（**Chrome 141 で終了予定**）。

---

## 🧾 WebGPU
- **subgroups**（SIMD レベル集団演算）で ML/メディアの高速化余地。

```js
const adapter = await navigator.gpu.requestAdapter();
if (adapter.features.has('subgroups')) {
  const device = await adapter.requestDevice({ requiredFeatures: ['subgroups'] });
  const info = adapter.info;
  console.log('subgroup sizes', info.subgroupMinSize, info.subgroupMaxSize);
}
```

---

### 導入指針メモ
- **フォームUI**: `<dialog closedby>` / カスタム `<select>` を段階導入（アクセシビリティと回復性に留意）
- **計測/集計**: Shared Storage 更新系は **withLock + batchUpdate** 前提に見直し
- **描画**: キャンバス拡縮品質は `imageSmoothingQuality` で制御
- **性能解析**: DevTools の新インサイトと `console.timeStamp()` の活用を標準手順に
- **GPU**: `subgroups` 利用可否を動的に分岐しフォールバックを用意
